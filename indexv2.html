<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Dados</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Visualização de Dados</h1>

    <!-- Dropdown para selecionar a tabela -->
    <label for="tableSelect">Escolha uma tabela:</label>
    <select id="tableSelect">
        <option value="" disabled selected>Selecione uma tabela</option>
    </select>
    <button onclick="loadVisualization()">Carregar Visualização</button>

    <!-- Canvas para o gráfico -->
    <div id="chartContainer" style="width: 100%; max-width: 600px; margin: auto; display: none;">
        <canvas id="chartCanvas" width="400" height="400"></canvas>
    </div>

    <!-- Tabela dinâmica (aparece para "Video Card Description") -->
    <div id="dataTable" style="display: none; margin-top: 20px;">
        <h2>Relatório de GPUs</h2>
        <table border="1" style="width: 100%; border-collapse: collapse; text-align: center;">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Categoria</th>
                    <th>Porcentagem (%)</th>
                    <th>Variação</th>
                </tr>
            </thead>
            <tbody id="dataRows"></tbody>
        </table>
    </div>

    <script>
        // Função para buscar tabelas disponíveis
        async function fetchTables() {
            const response = await fetch('http://localhost:5000/api/tables'); // Endpoint que retorna as tabelas
            if (!response.ok) {
                console.error('Erro ao buscar tabelas:', response.statusText);
                return [];
            }
            return await response.json();
        }

        // Função para carregar o menu dropdown com as tabelas desejadas e renomeadas
        async function populateTableDropdown() {
            const tables = await fetchTables();

            // Tabelas permitidas e seus nomes customizados
            const tableMapping = {
                'vram': 'VRAM UTILIZADA',
                'language': 'LINGUAGEM UTILIZADA',
                'video_card_description': 'MODELO DE GPU',
                'free_hard_drive_space': 'ESPAÇO LIVRE EM DISCO',
                'system_ram': 'MEMÓRIA RAM DO SISTEMA',
            };

            // Filtrar as tabelas disponíveis
            const filteredTables = tables
                .filter(table => table in tableMapping)
                .map(table => ({ value: table, label: tableMapping[table] }));

            const dropdown = document.getElementById('tableSelect');
            dropdown.innerHTML = ''; // Limpar o dropdown

            if (filteredTables.length === 0) {
                dropdown.innerHTML = '<option value="">Nenhuma tabela encontrada</option>';
            } else {
                filteredTables.forEach(({ value, label }) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    dropdown.appendChild(option);
                });
            }
        }

        // Função para buscar dados de uma tabela específica
        async function fetchData(tableName) {
            const response = await fetch(`http://localhost:5000/api/${tableName}`);
            if (!response.ok) {
                console.error('Erro ao buscar dados:', response.statusText);
                return [];
            }
            return await response.json();
        }

        // Função para criar uma tabela dinâmica
        function createDataTable(data) {
            const dataTable = document.getElementById('dataTable');
            const dataRows = document.getElementById('dataRows');

            dataTable.style.display = 'block'; // Exibir tabela
            dataRows.innerHTML = ''; // Limpar linhas

            data.forEach(item => {
                if (item.name) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${item.percentage.toFixed(2)}%</td>
                        <td>${item.change.toFixed(4)}</td>
                    `;
                    dataRows.appendChild(row);
                }
            });
        }

        // Função para criar o gráfico de pizza
        function createPieChart(data, tableName) {
            const chartContainer = document.getElementById('chartContainer');
            const chartCanvas = document.getElementById('chartCanvas');
            const ctx = chartCanvas.getContext('2d');

            chartContainer.style.display = 'block'; // Exibir gráfico

            // Limpa o canvas antes de criar um novo gráfico
            if (window.currentChart) {
                window.currentChart.destroy();
            }

            const labels = data.map(item => item.name || 'Desconhecido');
            const percentages = data.map(item => item.percentage);

            const backgroundColors = data.map(() =>
                `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.2)`
            );
            const borderColors = backgroundColors.map(color => color.replace('0.2', '1'));

            window.currentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Porcentagem',
                        data: percentages,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Distribuição - ${tableName}`
                        }
                    }
                }
            });
        }

        // Função para carregar a visualização da tabela selecionada
        async function loadVisualization() {
            const tableSelect = document.getElementById('tableSelect');
            const selectedTable = tableSelect.value;

            if (!selectedTable) {
                alert('Por favor, selecione uma tabela!');
                return;
            }

            const data = await fetchData(selectedTable);

            if (selectedTable === 'video_card_description') {
                document.getElementById('chartContainer').style.display = 'none'; // Esconder gráfico
                createDataTable(data); // Exibir dados em tabela
            } else {
                document.getElementById('dataTable').style.display = 'none'; // Esconder tabela
                createPieChart(data, selectedTable); // Exibir gráfico de pizza
            }
        }

        // Carrega o menu dropdown ao carregar a página
        window.onload = function() {
            populateTableDropdown();
        }
    </script>
</body>
</html>
